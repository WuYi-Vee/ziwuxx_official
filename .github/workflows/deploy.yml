name: Deploy to Aliyun HK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  SERVER_IP: ${{ vars.SERVER_IP }}
  SERVER_USER: ${{ vars.SERVER_USER }}
  WEB_ROOT: ${{ vars.WEB_ROOT }}
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“¦ Sync files to server
        run: |
          rsync -avz --delete \
            --exclude ".git*" \
            --exclude ".github" \
            --exclude "README.*" \
            --exclude "node_modules" \
            --exclude ".DS_Store" \
            --exclude "*.log" \
            --exclude "logs/" \
            ./ ${{ env.SERVER_USER }}@${{ env.SERVER_IP }}:${{ env.WEB_ROOT }}/

      - name: ğŸ” Create .env file on server
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
            cd ${{ env.WEB_ROOT }}

            # åˆ›å»º .env æ–‡ä»¶(å¦‚æœä¸å­˜åœ¨)
            if [ ! -f .env ]; then
              cat > .env << 'ENVEOF'
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          PORT=3000
          NODE_ENV=production
          ENVEOF
              echo "âœ… .env æ–‡ä»¶å·²åˆ›å»º"
            else
              echo "â„¹ï¸  .env æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
            fi
          EOF

      - name: ğŸ“¦ Install dependencies
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
            cd ${{ env.WEB_ROOT }}

            # æ£€æŸ¥ Node.js æ˜¯å¦å®‰è£…
            if ! command -v node &> /dev/null; then
              echo "âŒ Node.js æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Node.js"
              exit 1
            fi

            echo "ğŸ“¦ å®‰è£… npm ä¾èµ–..."
            npm install --production

            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          EOF

      - name: ğŸš€ Deploy with PM2
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
            cd ${{ env.WEB_ROOT }}

            # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ å®‰è£… PM2..."
              npm install -g pm2
            fi

            # æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²åœ¨è¿è¡Œ
            if pm2 describe ziwuxx-api &> /dev/null; then
              echo "ğŸ”„ é‡å¯åº”ç”¨..."
              pm2 restart ziwuxx-api
            else
              echo "ğŸš€ é¦–æ¬¡å¯åŠ¨åº”ç”¨..."
              pm2 start server.js --name ziwuxx-api
              pm2 save
            fi

            # æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
            echo ""
            echo "ğŸ“Š åº”ç”¨çŠ¶æ€:"
            pm2 list

            echo ""
            echo "âœ… éƒ¨ç½²å®Œæˆ!"
          EOF

      - name: ğŸ“Š Deployment Summary
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ!"
          echo ""
          echo "ğŸ“ éƒ¨ç½²ä¿¡æ¯:"
          echo "  - æœåŠ¡å™¨: ${{ env.SERVER_IP }}"
          echo "  - éƒ¨ç½²è·¯å¾„: ${{ env.WEB_ROOT }}"
          echo "  - Node.js ç‰ˆæœ¬: $(ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} 'node --version')"
          echo "  - åº”ç”¨åç§°: ziwuxx-api"
          echo ""
          echo "ğŸ”— è®¿é—®åœ°å€:"
          echo "  - ç”¨æˆ·è¡¨å•: http://${{ env.SERVER_IP }}:3000/contact-form.html"
          echo "  - ç®¡ç†åå°: http://${{ env.SERVER_IP }}:3000/admin.html"
          echo "  - APIå¥åº·æ£€æŸ¥: http://${{ env.SERVER_IP }}:3000/api/health"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "1. SSHå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®"
          echo "2. æœåŠ¡å™¨ä¸Šæ˜¯å¦å®‰è£…äº† Node.js"
          echo "3. MongoDBè¿æ¥å­—ç¬¦ä¸²æ˜¯å¦æ­£ç¡®"
          echo "4. æœåŠ¡å™¨é˜²ç«å¢™æ˜¯å¦å¼€æ”¾3000ç«¯å£"
